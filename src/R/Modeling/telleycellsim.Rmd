---
title: "TelleyCellSim"
output: html_notebook
---

```{r}
library(here)
source(here('src/R/Rprofile.R'))

#devtools::install_git(c('https://github.com/cran/SDMTools'))
#source("https://z.umn.edu/archived-seurat")
library(here)

library('DeconRNASeq')

stopifnot(!exists('FindVariableGenes'))

if(!file.exists(here('data/ft_agg_df.rds'))){
  library('Seurat')
  ss_emat <- projmemoise(fread)(Sys.glob(here('ext_data/GSE11*')))
  telleyseurat <- projmemoise(CreateSeuratObject)(raw.data = ss_emat[,-1]%>%as.matrix%>%set_rownames(ss_emat[[1]]))
  telleyseurat <- projmemoise(NormalizeData)(telleyseurat, normalization.method = 'LogNormalize',scale.factor=100000)
  telleyseurat <- projmemoise(ScaleData)(telleyseurat,vars.to.regress=c('nGene','nUMI'))
  telleyseurat <- FindVariableGenes(telleyseurat,mean.function  =  ExpMean,  dispersion.function  =  LogVMR,  x.low.cutoff  =  0.1, x.high.cutoff  =  8,  y.cutoff  =  0.7)
  
  library(readxl)
  telleyvargenes=here("ext_data/aav2522_Data-S7.xlsx")%>%read_xlsx
  telleyvargenes <- telleyvargenes$`Gene symbol`
  
  table(telleyseurat@var.genes %in% telleyvargenes)
  
  myvargenes = telleyseurat@var.genes
  telleyseurat@var.genes = telleyvargenes
  
    
  ft_mat <- telleyseurat@data%>%colnames%>%str_split('[\\.\\_]')%>%tail(-1)%>%simplify2array%>%t%>%
      .[,1:2]%>%set_colnames(c('fttime','ftdiff'))%>%
      as_tibble
  
  fttime=ft_mat$fttime[1]
  ftdiff=ft_mat$ftdiff[1]
  
  agg_counts<-lapply(unique(ft_mat$fttime)%>%setNames(.,.),function(fttime){
    lapply(unique(ft_mat$ftdiff)%>%setNames(.,.),function(ftdiff){
      telleyseurat
      telleyseurat@data%>%{.[,(ft_mat$fttime==fttime) & (ft_mat$ftdiff==ftdiff)]}%>%rowSums%>%as.data.frame%>%
      set_colnames(paste0(fttime,'_',ftdiff))
    })
  })
  
  ft_agg_df$gene_name <- telleyseurat@data%>%rownames
  ft_agg_df%<>%select(gene_name,everything())

  ft_agg_df <- agg_counts%>%map(.%>%bind_cols)%>%bind_cols
  

  saveRDS(ft_agg_df,here('data/ft_agg_df.rds'))
}else{
  message('loading')
  ft_agg_df<-readRDS(here('data/ft_agg_df.rds'))
}


stopifnot(!exists('FindVariableGenes'))

if(!exists('mscountvoom'))load(here('data/integrate_exprdata2.Rdata'))
mybulkmat = mscountvoom$E
mybulkdf <- mybulkmat%>%as.data.frame%>%rownames_to_column('uprotein_id')%>%left_join(metainfo%>%select(uprotein_id,gene_name))

min_ss_sig <- ft_agg_df[,-1]%>%as.matrix%>%rowMedians

shared_names <- ft_agg_df[min_ss_sig>100,]$gene_name%>%intersect(mybulkdf$gene_name)

mybulkdf <- mybulkdf%>%{.[match(shared_names,.$gene_name),]}%>%select(gene_name,matches('total'),matches('ribo'))%>%{set_rownames(as.data.frame(.[,-1]),.$gene_name)}
ft_aggmat <- ft_agg_df%>%{.[match(shared_names,.$gene_name),]}%>%select(gene_name,everything())%>%{set_rownames(as.data.frame(.[,-1]),.$gene_name)}

qplot(mybulkdf[[1]],ft_aggmat[[4]])

(DeconRNASeq::DeconRNASeq(2^mybulkdf,2^ft_aggmat))

```