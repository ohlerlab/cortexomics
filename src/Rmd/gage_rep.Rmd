---
title: "Differential Expression Analysis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
params:
  signalfile: NULL
  gene_set_file: 'gene_set_enrichment/allgenesets.gmt'
  sigcol: NULL

---

```{r setup, include=FALSE}
suppressMessages(library(gage))
suppressMessages(library(knitr))

knitr::opts_chunk$set(echo = FALSE, message = TRUE, warning = TRUE)

custom_log2fc_th <- 0
custom_q_value_cutoff <- 0.05
SETSIZEMAX <- 10e3
signalfile<-params$signalfile
sigcol<-params$sigcol
gene_set_file<-params$gene_set_file

```


```{r load_data}

message('reading gene sets')

gene_sets <- 
  readLines(gene_set_file)%>%
  str_split('\t')%>%
  setNames(.,map(.,1))%>%
  lapply(function(x)x[-c(1:2)])


message('reading signal')

log2_fc_tab <- fread(params$signalfile)

message('checking gene ids')

stopifnot(is.character(log2_fc_tab[[1]]))
stopifnot(!anyDuplicated(log2_fc_tab[[1]]))

if(is.null(sigcol)){
  possible_sigcols <- intersect(c('log2fc','signal'),colnames(log2_fc_tab))
  stopifnot(length(possible_sigcols)==1)
  sigcol <- possible_sigcols
}
log2_fc <- log2_fc_tab[[sigcol]]%>%setNames(log2_fc_tab[[1]])
log2_fc %<>% keep(Negate(is.na))

stopifnot(is.numeric(log2_fc))


!all(is.na(log2_fc_tab[[sigcol]]))

gene_sets%>%lapply(length)%>%stack%>%set_colnames(c('Size','Gene Set'))%>%kable

for(setnm in names(gene_sets)){
  message(str_interp('checking ${setnm}'))
  gene_sets[[setnm]]%<>%intersect(log2_fc_tab[[1]])
  stopifnot(all(gene_sets[[setnm]] %in% log2_fc_tab[[1]]))
  stopifnot(length(gene_sets[[setnm]])<SETSIZEMAX)
}

#all(log2_fc_tab[[1]] %in% fread(geneids)$gene_id)

signalsample<-paste0(collapse=',',round(sample(log2_fc_tab[[sigcol]],10),2))
message(str_interp('using signal values from ${sigcol} e.g. : ${signalsample}'))

``` 


#### gene set file `r gene_set_file` (`r length(gene_set)` sets)

```{r}


gene_sets%>%lapply(length)%>%stack%>%set_colnames(c('Number with Signal','Gene Set'))%>%kable

gene_sets['testgreater'] <- list(fread('xtail/xtail_P0.txt')%>%filter(adj_p_value < 0.05,log2fc > 1)%>%.$feature_id)
gene_sets['testlower'] <- list(fread('xtail/xtail_P0.txt')%>%filter(adj_p_value < 0.05,log2fc < -1)%>%.$feature_id)
gene_sets['testboth'] <- list(fread('xtail/xtail_P0.txt')%>%filter(adj_p_value < 0.05)%>%.$feature_id)

gage_result <- gage(log2_fc, 
                    gsets=gene_sets, 
                    ref=NULL, 
                    sample=NULL,
                   set.size=c(10,SETSIZEMAX))

comb_gage_result <- rbind(gage_result$greater %>% 
                            as.data.frame() %>%
                            tibble::rownames_to_column(var='set.name')%>%
                            mutate(direction='higher'),
                          gage_result$less %>% 
                            as.data.frame() %>% 
                            tibble::rownames_to_column(var='set.name') %>%
                            mutate(direction='lower')
                      )%>% 
    rowwise%>%dplyr::mutate(mean.log2FC=mean(log2_fc[gene_sets[[set.name]]],na.rm=TRUE)) %>%
    dplyr::arrange(p.val)%>%
    select(set.name,direction,mean.log2FC,p.val,everything())




# comb_gage_result%<>%group_by(set.name)%>%dplyr::slice(which.min(p.val))

# sig_gage_result <- comb_gage_result %>%
  # dplyr::filter(q.val < custom_q_value_cutoff) %>%
  # dplyr::filter(abs(mean.log2FC) > custom_log2fc_th)

sig_gage_result<-comb_gage_result

sig_gage_result%>%kable
sig_gage_result%>%filter(set.name%>%str_detect('test'))%>%as.data.frame
sig_gage_result%>%select(set.name,direction,mean.log2FC,p.val)%>%as.data.frame%>%mutate(p.val<0.05)
sig_gage_result<-comb_gage_result

```






There are `r dim(sig_gage_result)[1]` mis-regulated gene sets at q-value < `r custom_q_value_cutoff` and |mean log2 FC| > `r custom_log2fc_th`:
```

```{r }
library(DT)
if (dim(sig_gage_result)[1] > 0) {
  sig_gage_result %>%
    rowwise() %>%
    dplyr::mutate(set.genes=paste0(sort(gene_sets[[set.name]]),collapse=', ')) %>%
    dplyr::select(set.name,direction,set.size,mean.log2FC,p.val,q.val) %>% 
    dplyr::mutate(q.val = signif(q.val, 3), 
                  p.val = signif(p.val, 3),
                  mean.log2FC = signif(mean.log2FC, 2)) %>% 
    dplyr::mutate(set.name=paste0("<a href='http://software.broadinstitute.org/gsea/msigdb/cards/",set.name,"'>",set.name,"</a>")) %>%
    # dplyr::mutate(set_genes) %>%
    DT::datatable(rownames = F, 
                  escape = F,
                  extensions = 'Buttons', 
                  options = list(
                    dom='Bfrtip',
                    buttons = list(
                      list(
                        extend='csv',
                        buttons=c('csv'),
                        text='download',
                        exportOptions=list(
                          columns=c(seq(0,4),6)
                        )
                      )
                    ),
                    columnDefs = list(
                      list(
                        targets = 5,
                        render = JS(
                          "function(data, type, row, meta) {",
                          "return type === 'display' && data.length > 10 ?",
                          "'<span title=\"' + data + '\">' + data.substr(0, 10) + '...</span>' : data;",
                          "}")
                      ),
                      list(
                        visible=FALSE,
                        targets=6
                      )
                    )
                  )
    )
}
```
